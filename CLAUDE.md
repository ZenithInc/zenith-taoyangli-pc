# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a Hyperf-based PHP microservice application for a tourism/scenic spot website platform. It uses Swoole for high-performance coroutines and includes integrations with various external services (Aliyun, AWS, WeChat).

**Framework:** Hyperf 2.2 (PHP >= 8.0, Swoole >= 4.5)
**Architecture:** Repository-Service-Controller pattern with JSON-RPC support

## Development Commands

### Starting the Server
```bash
# Start the Hyperf server (runs on port 9501)
php bin/hyperf.php start

# Or using composer script
composer start
```

### Testing
```bash
# Run all tests with PHPUnit
composer test

# Run tests directly (co-phpunit for coroutine support)
co-phpunit --prepend test/bootstrap.php -c phpunit.xml --colors=always
```

### Code Quality
```bash
# Run PHP CS Fixer to fix code style
composer cs-fix

# Fix specific file/directory
php-cs-fixer fix app/Controller/SomeController.php

# Run PHPStan static analysis
composer analyse

# Or directly (level 0, memory limit 300M)
phpstan analyse --memory-limit 300M -l 0 -c phpstan.neon ./app ./config
```

### Dependencies
```bash
# Install dependencies (production)
composer install --no-dev -o

# Install all dependencies including dev
composer install
```

## Architecture

### Three-Layer Pattern
The application follows a strict repository-service-controller pattern:

1. **Controllers** (`app/Controller/`) - Handle HTTP requests/responses
   - Extend `BaseController` which provides `success()` and `failed()` response methods
   - Use custom `Response` class from `App\Core\Common\Container\Response`
   - Located primarily in `app/Controller/WebSite/` for website-facing endpoints

2. **Services** (`app/Services/`) - Business logic layer
   - Extend `BaseService` which provides automatic repository injection via magic `__get()`
   - Access repositories by property name ending in "Repository" (e.g., `$this->venueRepository`)
   - Use `BaseResultTrait` for standardized result formatting

3. **Repositories** (`app/Repositories/`) - Data access layer
   - Extend `BaseRepository` which auto-instantiates corresponding Model
   - Naming convention: `VenueRepository` maps to `Venue` model
   - Models located in `app/Model/`

### Request Flow
```
HTTP Request
→ RequestMiddleware (adds unique requestId to each request)
→ Router (config/routes.php)
→ Controller (validates, calls Service)
→ Service (business logic, calls Repository)
→ Repository (database operations via Model)
→ Response (formatted JSON via BaseController methods)
```

### Dependency Injection
- Services automatically inject repositories through `BaseService::__get()` magic method
- Repository name resolution: property name must end with "Repository"
- Example: `$this->venueRepository` in a service resolves to `App\Repositories\VenueRepository`

### JSON-RPC Services
- RPC client definitions in `app/JsonRpc/`
- Example: `ParkApiRpcService` provides methods for parking API integration
- Extends `AbstractServiceClient` with serviceName and protocol defined

## Configuration
- All config files in `config/autoload/`
- Routes defined in `config/routes.php` using Router facade
- Middleware registered in `config/autoload/middlewares.php`
- Database, Redis, cache, async queue, crontab all have separate config files

## Response Format
All API responses follow this structure:
```json
{
  "requestId": "unique-request-id",
  "return_code": 0,
  "msg": "success message",
  "data": {}
}
```

## Docker Deployment
- Dockerfile uses custom Hyperf base image with PHP 8.0 + Swoole
- GitLab CI/CD configured in `.gitlab-ci.yml`
- Build stages: build → push to registry → deploy via Docker Stack
- Separate pipelines for test branch and production tags

## Important Notes
- Server runs on port 9501 by default (configurable in `config/autoload/server.php`)
- Request IDs generated by `RequestMiddleware` for tracing
- Timezone: Asia/Shanghai
- Memory limit: 1G (configurable in `bin/hyperf.php`)
- Max coroutines: 100,000
- Helper functions loaded from `app/Helpers.php`
